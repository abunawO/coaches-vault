<div class="container" data-controller="confirm-modal">
  <div class="mx-auto max-w-3xl px-4">
    <%= render "shared/page_header",
          breadcrumbs: [["Dashboard", root_path], ["Messages", conversations_path]],
          title: content_tag(:span, "ðŸ’¬", class: "page-title-icon") + " Inbox",
          subtitle: "Direct messages between you and your students.",
          primary_action: { label: "Mark all as read", url: mark_all_read_conversations_path(tab: @tab, q: @q), method: :post } %>

    <div class="mv-card mv-inbox">
      <div class="mv-inbox__filters" style="display:flex; align-items:center; justify-content: space-between; gap:12px; flex-wrap:wrap;">
        <div class="inbox-tabs" style="margin:0;">
          <%= link_to "All", conversations_path(tab: "all", q: @q), class: inbox_tab_class("all", @tab), aria: { current: ("page" if @tab == "all") } %>
          <%= link_to "Unread", conversations_path(tab: "unread", q: @q), class: inbox_tab_class("unread", @tab), aria: { current: ("page" if @tab == "unread") } %>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <%= form_with url: conversations_path, method: :get, local: true, class: "inline-form" do |f| %>
            <%= hidden_field_tag :tab, @tab %>
            <%= f.search_field :q, value: @q, placeholder: "Search inboxâ€¦", class: "input", style: "width:200px;" %>
          <% end %>
          <% if @q.present? %>
            <%= link_to "Clear", conversations_path(tab: @tab), class: "btn btn-secondary btn-small" %>
          <% end %>
        </div>
      </div>

      <% if @conversations.any? %>
        <div class="mv-inbox__list" data-controller="notification-rows">
          <% @conversations.each do |conversation| %>
            <% other_user = conversation.other_party(current_user) %>
            <% last_message = conversation.messages.max_by(&:created_at) %>
            <% unread = last_message.present? && last_message.read_at.nil? && last_message.sender_id != current_user.id %>
            <% preview_prefix = last_message&.sender_id == current_user.id ? "You: " : "" %>
            <% preview_text = last_message ? truncate(last_message.body, length: 140) : nil %>
            <div class="mv-inbox__row <%= 'mv-inbox__row--unread' if unread %>" id="<%= dom_id(conversation) %>">
              <div class="mv-inbox__icon">
                <div class="mv-inbox__avatar"><%= other_user&.email.to_s.first&.upcase %></div>
              </div>
              <div class="mv-inbox__main">
                <div class="mv-inbox__title">
                  <% if unread %><span class="mv-inbox__unread-dot" aria-hidden="true"></span><% end %>
                  <strong><%= other_user&.email || "Conversation" %></strong>
                </div>
                <% if preview_text %>
                  <div class="mv-inbox__preview muted"><%= preview_prefix %><%= preview_text %></div>
                <% end %>
              </div>
              <div class="mv-inbox__time muted"><%= last_message ? time_ago_in_words(last_message.created_at) : "" %><%= last_message ? " ago" : "" %></div>
              <div class="mv-inbox__right">
                <div class="mv-chip <%= unread ? 'mv-chip--subscribers' : 'mv-chip--free' %>">
                  <span class="mv-chip__dot"></span>
                  <%= unread ? "Unread" : "Read" %>
                </div>
                <div class="mv-inbox__actions">
                  <%= link_to "Open", conversation_path(conversation), class: "btn btn-secondary btn-small mv-inbox__open" %>
                  <button type="button"
                          class="icon-btn icon-btn--danger notification-delete"
                          data-action="click->notification-rows#confirm"
                          data-notification-id="<%= conversation.id %>"
                          aria-label="Delete conversation"
                          data-tooltip="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"/></svg>
                  </button>
                </div>
                <div class="notification-confirm" data-notification-id="<%= conversation.id %>" data-notification-rows-target="confirm">
                  <span class="muted small-text">Delete this conversation?</span>
                  <div class="notification-confirm__actions">
                    <button type="button" class="btn btn-secondary btn-small" data-action="click->notification-rows#cancel">Cancel</button>
                    <%= button_to "Delete",
                          conversation_path(conversation),
                          method: :delete,
                          form: { data: { turbo_stream: true }, class: "inline-form" },
                          class: "btn btn-primary btn-small" %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <% if @tab == "unread" %>
          <%= render "shared/empty_state",
              icon: "ðŸ’¬",
              title: (@q.present? ? "No results" : "No unread messages"),
              body: (@q.present? ? "No conversations match â€œ#{@q}â€." : "Youâ€™re all caught up. When someone messages you, itâ€™ll appear here."),
              primary_action: (@q.present? ? { label: "Clear search", url: conversations_path(tab: @tab) } : { label: "View all messages", url: conversations_path(tab: "all") }),
              secondary_action: { label: "Go to dashboard", url: root_path },
              size: :sm %>
        <% else %>
          <%= render "shared/empty_state",
              icon: "ðŸ’¬",
              title: (@q.present? ? "No results" : "No conversations yet"),
              body: (@q.present? ? "No conversations match â€œ#{@q}â€." : "Messages between you and your students will appear here."),
              primary_action: (@q.present? ? { label: "Clear search", url: conversations_path(tab: @tab) } : { label: "View subscribers", url: subscribers_path }),
              secondary_action: { label: "Go to dashboard", url: root_path },
              size: :sm %>
        <% end %>
      <% end %>
    </div>
  </div>

</div>
