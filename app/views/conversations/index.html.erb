<div class="container" data-controller="confirm-modal">
  <div class="mx-auto max-w-3xl px-4">
    <%= render "shared/page_header",
          breadcrumbs: [["Dashboard", root_path], ["Messages", conversations_path]],
          title: content_tag(:span, "üí¨", class: "page-title-icon") + " Inbox",
          subtitle: "Direct messages between you and your students.",
          primary_action: { label: "Mark all as read", url: mark_all_read_conversations_path(tab: @tab, q: @q), method: :post } %>

    <div class="mv-card mv-inbox">
      <div class="mv-inbox__filters" style="display:flex; align-items:center; justify-content: space-between; gap:12px; flex-wrap:wrap;">
        <div class="inbox-tabs" style="margin:0;">
          <%= link_to "All", conversations_path(tab: "all", q: @q), class: inbox_tab_class("all", @tab), aria: { current: ("page" if @tab == "all") } %>
          <%= link_to "Unread", conversations_path(tab: "unread", q: @q), class: inbox_tab_class("unread", @tab), aria: { current: ("page" if @tab == "unread") } %>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <%= form_with url: conversations_path, method: :get, local: true, class: "inline-form" do |f| %>
            <%= hidden_field_tag :tab, @tab %>
            <%= f.search_field :q, value: @q, placeholder: "Search inbox‚Ä¶", class: "input", style: "width:200px;" %>
          <% end %>
          <% if @q.present? %>
            <%= link_to "Clear", conversations_path(tab: @tab), class: "btn btn-secondary btn-small" %>
          <% end %>
        </div>
      </div>

      <% if @conversations.any? %>
        <div class="mv-inbox__list">
          <% @conversations.each do |conversation| %>
            <% other_user = conversation.other_party(current_user) %>
            <% last_message = conversation.messages.max_by(&:created_at) %>
            <% unread = last_message.present? && last_message.read_at.nil? && last_message.sender_id != current_user.id %>
            <% preview_prefix = last_message&.sender_id == current_user.id ? "You: " : "" %>
            <% preview_text = last_message ? truncate(last_message.body, length: 140) : nil %>
            <div class="mv-inbox__row <%= 'mv-inbox__row--unread' if unread %>">
              <div class="mv-inbox__icon">
                <div class="mv-inbox__avatar"><%= other_user&.email.to_s.first&.upcase %></div>
              </div>
              <div class="mv-inbox__main">
                <div class="mv-inbox__title">
                  <% if unread %><span class="mv-inbox__unread-dot" aria-hidden="true"></span><% end %>
                  <strong><%= other_user&.email || "Conversation" %></strong>
                </div>
                <% if preview_text %>
                  <div class="mv-inbox__preview muted"><%= preview_prefix %><%= preview_text %></div>
                <% end %>
              </div>
              <div class="mv-inbox__time muted"><%= last_message ? time_ago_in_words(last_message.created_at) : "" %><%= last_message ? " ago" : "" %></div>
              <div class="mv-inbox__right">
                <div class="mv-chip <%= unread ? 'mv-chip--subscribers' : 'mv-chip--free' %>">
                  <span class="mv-chip__dot"></span>
                  <%= unread ? "Unread" : "Read" %>
                </div>
                <%= link_to "Open", conversation_path(conversation), class: "btn btn-secondary btn-small mv-inbox__open" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <% if @tab == "unread" %>
          <div class="card empty-state">
            <h3><%= @q.present? ? "No results" : "No unread messages" %></h3>
            <p class="muted">
              <% if @q.present? %>
                No conversations match ‚Äú<%= @q %>‚Äù.
              <% else %>
                You‚Äôre all caught up. When someone messages you, it‚Äôll appear here.
              <% end %>
            </p>
            <div class="card-actions" style="justify-content: center;">
              <% if @q.present? %>
                <%= link_to "Clear search", conversations_path(tab: @tab), class: "btn btn-primary" %>
              <% else %>
                <%= link_to "View all messages", conversations_path(tab: "all"), class: "btn btn-primary" %>
              <% end %>
              <%= link_to "Go to dashboard", root_path, class: "btn btn-secondary" %>
            </div>
          </div>
        <% else %>
          <div class="card empty-state">
            <h3><%= @q.present? ? "No results" : "No messages yet" %></h3>
            <p class="muted">
              <% if @q.present? %>
                No conversations match ‚Äú<%= @q %>‚Äù.
              <% else %>
                When a conversation starts, it will show up here.
              <% end %>
            </p>
            <div class="card-actions" style="justify-content: center;">
              <% if @q.present? %>
                <%= link_to "Clear search", conversations_path(tab: @tab), class: "btn btn-primary" %>
              <% else %>
                <%= link_to "Browse coaches", coaches_path, class: "btn btn-primary" %>
              <% end %>
              <%= link_to "Go to dashboard", root_path, class: "btn btn-secondary" %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

</div>
