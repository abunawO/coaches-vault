<div class="container profile-page">
    <section class="profile-hero coach-hero">
      <div class="coach-hero__top">
        <div class="profile-avatar coach-hero__avatar">
            <% if @coach_profile.avatar.attached? %>
                <% begin %>
                    <%= image_tag url_for(@coach_profile.avatar.variant(resize_to_fill: [160, 160])), alt: @coach_profile.display_name, class: "avatar-img" %>
                <% rescue StandardError %>
                    <%= image_tag url_for(@coach_profile.avatar), alt: @coach_profile.display_name, class: "avatar-img" %>
                <% end %>
            <% elsif @coach_profile.avatar_url.present? %>
                <div class="profile-avatar__bg" style="background-image: url('<%= @coach_profile.avatar_url %>');"></div>
            <% else %>
                <div class="profile-avatar__placeholder"></div>
            <% end %>
        </div>
        <div class="profile-meta coach-hero__body">
          <div class="coach-hero__identity">
              <div class="profile-name-row">
                  <h1 class="profile-name"><%= @coach_profile.display_name %></h1>
                  <span class="profile-handle">@<%= @coach_profile.slug %></span>
                  <% if @coach_profile.verified? %>
                  <span class="verified-badge">Verified</span>
                  <% end %>
              </div>
              <% if @coach_profile.headline.present? %>
              <p class="coach-headline"><%= @coach_profile.headline %></p>
              <% end %>
              <% if @coach_profile.bio.present? %>
              <p class="profile-bio"><%= @coach_profile.bio %></p>
              <% end %>
              <% if @coach_profile.location.present? %>
              <p class="profile-location">üìç <%= @coach_profile.location %></p>
              <% end %>
          </div>
          <div class="profile-socials coach-hero__links">
              <% if @coach_profile.instagram_url.present? %>
              <%= link_to "Instagram", @coach_profile.instagram_url, class: "social-link", target: "_blank", rel: "noopener" %>
              <% end %>
              <% if @coach_profile.youtube_url.present? %>
              <%= link_to "YouTube", @coach_profile.youtube_url, class: "social-link", target: "_blank", rel: "noopener" %>
              <% end %>
              <% if @coach_profile.website_url.present? %>
              <%= link_to "Website", @coach_profile.website_url, class: "social-link", target: "_blank", rel: "noopener" %>
              <% end %>
              <% if @coach_profile.tiktok_url.present? %>
              <%= link_to "TikTok", @coach_profile.tiktok_url, class: "social-link", target: "_blank", rel: "noopener" %>
              <% end %>
          </div>
          <% subscribed_student = current_user&.student? && current_user.subscribed_to?(@coach) %>
          <% owning_coach = current_user&.coach? && current_user.id == @coach.id %>
          <% actions_class = "profile-actions coach-hero__actions" %>
          <% if current_user&.student? && logged_in? && !subscribed_student && !owning_coach %>
            <% actions_class += " actions--stack" %>
          <% end %>
          <div class="<%= actions_class %>">
              <% if !logged_in? %>
              <%= link_to "Explore Lessons", public_coach_lessons_path(@coach_profile.slug), class: "btn btn-primary", aria: { label: "Explore lessons" } %>
              <%= link_to "Log in to subscribe", login_path, class: "btn btn-secondary", aria: { label: "Log in to subscribe" } %>
              <% elsif owning_coach %>
              <%= link_to "Go to Vault", coach_public_vault_path(@coach_profile.slug), class: "btn btn-secondary", aria: { label: "Go to vault" } %>
              <%= link_to "Edit profile", edit_my_coach_profile_path, class: "btn btn-secondary", aria: { label: "Edit profile" } %>
              <span class="muted coach-hero__note">You are viewing your profile.</span>
              <% elsif current_user.student? %>
              <% if subscribed_student %>
              <%= button_to "Message", conversations_path(coach_id: @coach.id), method: :post, form_class: "coach-hero__action-form", class: "btn btn-secondary", aria: { label: "Message coach" } %>
              <%= link_to "Go to Vault", coach_public_vault_path(@coach_profile.slug), class: "btn btn-secondary", aria: { label: "Go to vault" } %>
              <% else %>
              <%= button_to "Subscribe to unlock all lessons", coach_subscription_path(@coach), method: :post, form_class: "coach-hero__action-form", class: "btn btn-primary", aria: { label: "Subscribe to unlock all lessons" } %>
              <%= link_to "View free lessons", public_coach_lessons_path(@coach_profile.slug), class: "btn btn-secondary", aria: { label: "View free lessons" } %>
              <button class="btn btn-secondary" aria-label="Subscribe to message this coach" disabled>üîí Message (subscribers only)</button>
              <% end %>
          <% else %>
          <%= link_to "Explore Lessons", public_coach_lessons_path(@coach_profile.slug), class: "btn btn-primary", aria: { label: "Explore lessons" } %>
              <% end %>
          </div>
      </div>
      <div class="coach-metrics" aria-label="Coach stats">
          <div class="coach-metric">
              <div class="coach-metric__value"><%= @coach.lessons.count %></div>
              <div class="coach-metric__label">Lessons</div>
          </div>
          <div class="coach-metric">
              <div class="coach-metric__value"><%= Subscription.active.where(coach_id: @coach.id).distinct.count(:student_id) %></div>
              <div class="coach-metric__label">Subscribers</div>
          </div>
      </div>
    </section>

    <% featured_lessons = @coach.lessons.order(created_at: :desc).limit(6) %>
    <% latest_lessons = @coach.lessons.order(created_at: :desc).limit(5) %>

    <section class="profile-section">
        <div class="profile-content">
            <div class="profile-featured">
                <div class="section-header profile-lessons-header">
                    <h2 class="section-title">Featured lessons</h2>
                    <%= link_to "View all lessons ‚Üí", public_coach_lessons_path(@coach_profile.slug), class: "view-all-link", aria: { label: "View all lessons" } %>
                </div>
                <div class="profile-grid">
                    <% featured_lessons.each do |lesson| %>
                    <% lesson_path_to_use = public_coach_lesson_path(@coach_profile.slug, lesson) %>
                    <% locked = !(subscribed_student || owning_coach) %>
                    <%= link_to lesson_path_to_use, class: "profile-tile #{'tile-locked' if locked}" do %>
                    <div class="tile-thumb" style="background-image: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%);"></div>
                    <div class="tile-overlay">
                        <h3><%= lesson.title %></h3>
                        <p><%= truncate(lesson.description.to_s, length: 80) %></p>
                        <% if locked %>
                        <span class="badge badge-warning">Subscriber-only</span>
                        <% end %>
                    </div>
                    <% end %>
                    <% end %>
                </div>
            </div>

            <aside class="profile-latest">
                <div class="section-header">
                    <h3 class="section-title">Latest drops</h3>
                </div>
                <div class="latest-list">
                    <% latest_lessons.each do |lesson| %>
                    <%= link_to public_coach_lesson_path(@coach_profile.slug, lesson), class: "latest-card" do %>
                    <div class="latest-title"><%= lesson.title %></div>
                    <% if lesson.description.present? %>
                    <div class="latest-desc"><%= truncate(lesson.description, length: 90) %></div>
                    <% end %>
                    <div class="latest-meta muted">Dropped <%= l(lesson.created_at, format: :short) %></div>
                    <% end %>
                    <% end %>
                </div>
            </aside>
        </div>
    </section>
</div>
