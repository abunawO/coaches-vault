<div class="container coach-vault" data-controller="student-vault" data-student-vault-selected-id-value="<%= params[:category_id] %>">
  <div class="vault-header card">
    <div class="vault-header__info">
      <% if @coach_profile.avatar.attached? %>
        <% begin %>
          <%= image_tag url_for(@coach_profile.avatar.variant(resize_to_fill: [96, 96])), alt: @coach_profile.display_name, class: "vault-avatar__img" %>
        <% rescue StandardError %>
          <%= image_tag url_for(@coach_profile.avatar), alt: @coach_profile.display_name, class: "vault-avatar__img" %>
        <% end %>
      <% elsif @coach_profile.avatar_url.present? %>
        <div class="vault-avatar" style="background-image: url('<%= @coach_profile.avatar_url %>');"></div>
      <% else %>
        <div class="vault-avatar vault-avatar--placeholder"></div>
      <% end %>
      <div>
        <h1 class="vault-title"><%= @coach_profile.display_name %>â€™s Vault</h1>
        <p class="muted small-text vault-handle">@<%= @coach_profile.slug %></p>
      </div>
    </div>
    <div class="vault-header__actions">
      <% subscribed = current_user&.student? && current_user.subscribed_to?(@coach) %>
      <% owning_coach = current_user&.coach? && current_user.id == @coach.id %>
      <% if subscribed || owning_coach %>
        <span class="pill-soft pill-success">Unlocked</span>
      <% else %>
        <%= button_to "Subscribe to unlock", coach_subscription_path(@coach), method: :post, class: "btn btn-primary btn-small" %>
      <% end %>
      <input type="search" class="input vault-search" placeholder="Search lessonsâ€¦" data-student-vault-target="searchInput" aria-label="Search lessons">
    </div>
  </div>

  <% if @categories.empty? %>
    <div class="card">
      <p class="muted">This coach hasnâ€™t organized lessons into a vault yet.</p>
    </div>
  <% else %>
    <div class="vault-rows">
      <% @categories.each do |category| %>
        <% category_lessons = category.category_lessons.includes(:lesson).sort_by { |cl| cl.position || 0 } %>
        <% preview_titles = category_lessons.first(2).map { |cl| cl.lesson.title } %>
        <section class="vault-row" data-student-vault-target="lessonPanel" data-category-id="<%= category.id %>">
          <div class="vault-row__header">
            <div>
              <h3 class="vault-row__title"><%= category.name %></h3>
              <% if category.description.present? %>
                <p class="muted small-text"><%= category.description %></p>
              <% end %>
              <% if preview_titles.any? %>
                <p class="muted tiny-text">Top lessons: <%= preview_titles.join(", ") %></p>
              <% end %>
            </div>
            <div class="vault-row__meta">
              <span class="pill-soft"><%= pluralize(category_lessons.count, "lesson") %></span>
            </div>
          </div>

          <% if category_lessons.empty? %>
            <p class="muted">No lessons in this category yet.</p>
          <% else %>
            <div class="vault-row__scroller" data-student-vault-target="rowScroller">
              <% category_lessons.each do |cl| %>
                <% lesson = cl.lesson %>
                <% access = lesson.viewer_access_level(current_user) %>
                <% locked = access != :full %>
                <% link_target =
                    if locked
                      logged_in? ? coach_subscription_path(@coach) : login_path
                    else
                      public_coach_lesson_path(@coach_profile.slug, lesson)
                    end %>
                <% link_options = locked && logged_in? ? { method: :post } : {} %>
                <% searchable = [lesson.title, lesson.description].compact.join(" ").downcase %>
                <%= link_to link_target, link_options.merge(class: "vault-lesson-card vault-lesson-card--tile #{'is-locked' if locked}", data: { student_vault_target: "lessonCard", search: searchable }) do %>
                  <div class="vault-lesson-card__title"><%= lesson.title %></div>
                  <% if lesson.description.present? %>
                    <div class="muted small-text"><%= truncate(lesson.description, length: 120) %></div>
                  <% end %>
                  <div class="vault-lesson-card__meta muted small-text">
                    <span><%= l(lesson.created_at, format: :short) %></span>
                    <% if locked %>
                      <span class="pill-soft pill-warning">Locked</span>
                    <% else %>
                      <span class="pill-soft pill-success">Unlocked</span>
                    <% end %>
                  </div>
                  <% if locked %>
                    <div class="vault-lesson-card__lock" aria-hidden="true">ðŸ”’</div>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </section>
      <% end %>
    </div>
  <% end %>
</div>
