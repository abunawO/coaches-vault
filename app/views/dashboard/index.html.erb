<div class="container">
  <% if current_user.coach? %>
    <%= render "shared/page_header",
          breadcrumbs: [["Dashboard", root_path]],
          title: content_tag(:span, "ðŸ“Š", class: "page-title-icon") + " Coach dashboard",
          subtitle: current_user.coach_profile&.display_name || "Overview of your vault.",
          primary_action: { label: "Create new lesson", url: new_coach_lesson_path },
          secondary_actions: [
            { label: "Manage content", url: coach_content_path },
            (current_user.coach_profile.present? ? { label: "View public page", url: coach_path(current_user.coach_profile.slug), class: "btn btn-ghost" } : nil)
          ].compact,
          meta: [
            { label: "Lessons", value: (@lesson_count || 0) },
            { label: "Subscribers", value: (@subscriber_count || 0) }
          ] %>

    <div class="grid-3">
      <div class="mv-card">
        <div class="mv-card__header" style="align-items:flex-end;">
          <div>
            <span class="muted">Total lessons</span>
            <h3 class="mv-card__title" style="font-size:1.4rem; margin-top:4px;"><%= @lesson_count || 0 %></h3>
          </div>
        </div>
      </div>
      <div class="mv-card">
        <div class="mv-card__header" style="align-items:flex-end;">
          <div>
            <span class="muted">Locked lessons</span>
            <h3 class="mv-card__title" style="font-size:1.4rem; margin-top:4px;">â€”</h3>
          </div>
        </div>
      </div>
      <div class="mv-card">
        <div class="mv-card__header" style="align-items:flex-end;">
          <div>
            <span class="muted">Subscribers</span>
            <h3 class="mv-card__title" style="font-size:1.4rem; margin-top:4px;"><%= @subscriber_count || 0 %></h3>
          </div>
        </div>
      </div>
    </div>

    <section class="section">
      <div class="section-header">
        <h2>Recent lessons</h2>
      </div>
      <% if @recent_lessons.present? %>
        <div class="grid">
          <% @recent_lessons.each do |lesson| %>
            <div class="mv-card">
              <div class="mv-card__header">
                <div>
                  <h3 class="mv-card__title"><%= lesson.title %></h3>
                  <% if lesson.description.present? %>
                    <p class="mv-card__subtitle"><%= truncate(lesson.description, length: 140) %></p>
                  <% end %>
                </div>
              </div>
              <div class="mv-card__meta">
                <span>ðŸ“… <%= time_ago_in_words(lesson.created_at) %> ago</span>
              </div>
              <div style="height:1px; background:#edf2f7; margin: 10px 0;"></div>
              <div class="mv-card__actions">
                <%= link_to "View", lesson_path(lesson), class: "btn btn-primary btn-small" %>
                <%= link_to "Edit", edit_coach_lesson_path(lesson), class: "btn btn-secondary btn-small" %>
                <button type="button"
                        class="btn btn-danger btn-small"
                        data-action="confirm-modal#open"
                        data-confirm-title="Delete lesson?"
                        data-confirm-body="This will permanently delete this lesson. This cannot be undone."
                        data-confirm-action="<%= coach_lesson_path(lesson) %>"
                        data-confirm-method="delete"
                        data-confirm-label="Delete">Delete</button>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="card">
          <p class="muted">No lessons yet.</p>
          <div class="card-actions">
            <%= link_to "Create your first lesson", new_coach_lesson_path, class: "btn btn-primary" %>
          </div>
        </div>
      <% end %>
    </section>

  <% else %>
    <section class="card dashboard-hero">
      <div class="dashboard-hero-header">
        <div>
          <p class="muted">Dashboard</p>
          <h1 class="page-title">Welcome back</h1>
          <p class="page-subtitle"><%= current_user.email %></p>
        </div>
        <%= link_to "Refresh", root_path, class: "btn btn-secondary" %>
      </div>

      <div class="dashboard-hero-stats">
        <span class="pill"><%= current_user.role.capitalize %></span>
        <% if current_user.student? %>
          <span class="pill">Subscriptions: <%= @subscription_count || 0 %></span>
        <% end %>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <div>
          <p class="muted">Explore Vaults</p>
          <h2>Featured lessons</h2>
        </div>
      </div>

      <div class="video-grid">
        <% @feed_lessons.each do |lesson| %>
          <% coach_profile = lesson.coach&.coach_profile %>
          <% coach_name = coach_profile&.display_name || lesson.coach&.email || "Coach" %>
          <% access_level = lesson.viewer_access_level(current_user) %>
          <% open_path = if coach_profile&.slug && lesson.respond_to?(:slug) && lesson.slug.present?
                           public_coach_lesson_path(coach_profile.slug, lesson.slug)
                         elsif coach_profile&.slug
                           public_coach_lesson_path(coach_profile.slug, lesson)
                         else
                           lesson_path(lesson)
                         end %>
          <% locked_path = coach_profile&.slug ? coach_path(coach_profile.slug) : coaches_path %>
          <% thumb = lesson_thumbnail_url(lesson) %>
          <%= link_to open_path, class: "video-card #{'video-card-locked' if access_level == :locked}" do %>
            <div class="video-thumb" style="background-image: url('<%= thumb || '' %>');">
              <% unless thumb.present? %>
                <div class="thumb-placeholder">
                  <span class="play-icon">â–¶</span>
                </div>
              <% end %>
              <div class="thumb-overlay">
                <span class="badge badge-neutral"><%= lesson.visibility == "restricted" ? "Private" : lesson.visibility.capitalize %></span>
                <% if access_level == :preview %>
                  <span class="badge badge-warning">Preview</span>
                <% end %>
                <% if access_level == :locked %>
                  <span class="badge badge-warning">Locked</span>
                <% end %>
              </div>
            </div>
            <div class="video-meta">
              <div class="video-title"><%= truncate(lesson.title, length: 70) %></div>
              <div class="video-subtitle">by <%= coach_name %></div>
              <div class="video-info">
                <% if access_level == :preview %>
                  Preview available
                <% elsif lesson.visibility == "free" %>
                  Free
                <% else %>
                  Subscribers
                <% end %>
                <span class="muted">â€¢ <%= time_ago_in_words(lesson.created_at) %> ago</span>
              </div>
              <% if access_level == :preview && lesson.preview_text.present? %>
                <div class="video-snippet"><%= truncate(lesson.preview_text, length: 90) %></div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </section>
    <% end %>
</div>
