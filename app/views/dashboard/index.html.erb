<div class="container">
  <% if current_user.coach? %>
    <%= render "shared/page_header",
          breadcrumbs: [["Dashboard", root_path]],
          title: content_tag(:span, "ðŸ“Š", class: "page-title-icon") + " Coach dashboard",
          subtitle: current_user.coach_profile&.display_name || "Overview of your vault.",
          primary_action: { label: "New Lesson", url: new_coach_lesson_path(return_to: request.fullpath) },
          secondary_actions: [
            { label: "Manage content", url: coach_content_path },
            (current_user.coach_profile.present? ? { label: "View public page", url: coach_path(current_user.coach_profile.slug), class: "btn btn-ghost" } : nil)
          ].compact,
          meta: [
            { label: "Lessons", value: (@lesson_count || 0) },
            { label: "Subscribers", value: (@subscriber_count || 0) }
          ] %>

    <div class="grid-3">
      <div class="mv-card">
        <div class="mv-card__header" style="align-items:flex-end;">
          <div>
            <span class="muted">Total lessons</span>
            <h3 class="mv-card__title" style="font-size:1.4rem; margin-top:4px;"><%= @lesson_count || 0 %></h3>
          </div>
        </div>
      </div>
      <div class="mv-card">
        <div class="mv-card__header" style="align-items:flex-end;">
          <div>
            <span class="muted">Locked lessons</span>
            <h3 class="mv-card__title" style="font-size:1.4rem; margin-top:4px;">â€”</h3>
          </div>
        </div>
      </div>
      <div class="mv-card">
        <div class="mv-card__header" style="align-items:flex-end;">
          <div>
            <span class="muted">Subscribers</span>
            <h3 class="mv-card__title" style="font-size:1.4rem; margin-top:4px;"><%= @subscriber_count || 0 %></h3>
          </div>
        </div>
      </div>
    </div>

    <section class="section">
      <div class="section-header">
        <h2>Recent lessons</h2>
      </div>
      <% if @recent_lessons.present? %>
        <div class="grid">
          <% @recent_lessons.each do |lesson| %>
            <div class="mv-card">
              <div class="mv-card__header">
                <div>
                  <h3 class="mv-card__title"><%= lesson.title %></h3>
                  <% if lesson.description.present? %>
                    <p class="mv-card__subtitle"><%= truncate(lesson.description, length: 140) %></p>
                  <% end %>
                </div>
              </div>
              <div class="mv-card__meta">
                <span>ðŸ“… <%= time_ago_in_words(lesson.created_at) %> ago</span>
              </div>
              <div class="mv-card__actions">
                <%= link_to lesson_path(lesson), class: "icon-btn", aria: { label: "View" }, data: { tooltip: "View" } do %>
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 9s3-6 11-6 11 6 11 6-3 6-11 6S1 9 1 9Z"/><circle cx="12" cy="9" r="2.5"/></svg>
                <% end %>
                <%= link_to edit_coach_lesson_path(lesson), class: "icon-btn", aria: { label: "Edit" }, data: { tooltip: "Edit" } do %>
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4Z"/></svg>
                <% end %>
                <button type="button"
                        class="icon-btn icon-btn--danger"
                        data-action="confirm-modal#open"
                        data-confirm-title="Delete lesson?"
                        data-confirm-body="This will permanently delete this lesson. This cannot be undone."
                        data-confirm-action="<%= coach_lesson_path(lesson) %>"
                        data-confirm-method="delete"
                        data-confirm-label="Delete"
                        aria-label="Delete"
                        data-tooltip="Delete">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"/></svg>
                </button>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <%= render "shared/empty_state",
            icon: "ðŸ“š",
            title: "Your vault is ready â€” letâ€™s build it",
            body: "Start by creating your first lesson. Once published, students can subscribe and begin learning from you.",
            primary_action: { label: "Create your first lesson", url: new_coach_lesson_path(return_to: request.fullpath) },
            secondary_action: { label: "View public page", url: public_vault_path } %>
      <% end %>
    </section>

  <% else %>
    <section class="card dashboard-hero">
      <% student_profile = current_user.student_profile %>
      <% initials = current_user.email.to_s.first(2).upcase %>
      <div class="dashboard-hero__top">
        <div class="dashboard-hero__identity">
          <div class="hero__avatar">
            <% if student_profile&.avatar&.attached? %>
              <% begin %>
                <%= image_tag url_for(student_profile.avatar.variant(resize_to_fill: [48, 48])), alt: student_profile.display_name, class: "avatar-img" %>
              <% rescue StandardError %>
                <%= image_tag url_for(student_profile.avatar), alt: student_profile.display_name, class: "avatar-img" %>
              <% end %>
            <% else %>
              <span class="avatar-fallback"><%= initials %></span>
            <% end %>
          </div>
          <div class="dashboard-hero__text">
            <div class="hero__kicker muted">Dashboard</div>
            <div class="hero__name">Welcome back, <%= student_profile&.display_name.presence || current_user.email %></div>
            <div class="hero__meta"><%= student_profile&.location.presence || current_user.email %></div>
            <div class="dashboard-hero__chips">
              <span class="pill"><%= current_user.role.capitalize %></span>
              <% if current_user.student? %>
                <span class="pill">Subscriptions: <%= @subscription_count || 0 %></span>
              <% end %>
            </div>
          </div>
        </div>
        <div class="dashboard-hero__actions">
          <% if current_user.student? %>
            <%= link_to "Edit profile", edit_my_student_profile_path, class: "btn btn-secondary btn--compact" %>
          <% end %>
          <%= link_to "Refresh", root_path, class: "btn btn-ghost btn--compact" %>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <div>
          <p class="muted">Explore Vaults</p>
          <h2>Featured lessons</h2>
        </div>
      </div>

      <div class="video-grid">
        <% @feed_lessons.each do |lesson| %>
          <% coach_profile = lesson.coach&.coach_profile %>
          <% coach_name = coach_profile&.display_name || lesson.coach&.email || "Coach" %>
          <% access_level = lesson.viewer_access_level(current_user) %>
          <% open_path = if coach_profile&.slug && lesson.respond_to?(:slug) && lesson.slug.present?
                           public_coach_lesson_path(coach_profile.slug, lesson.slug)
                         elsif coach_profile&.slug
                           public_coach_lesson_path(coach_profile.slug, lesson)
                         else
                           lesson_path(lesson)
                         end %>
          <% locked_path = coach_profile&.slug ? coach_path(coach_profile.slug) : coaches_path %>
          <% thumb = lesson_thumbnail_url(lesson) %>
          <%= link_to open_path, class: "video-card #{'video-card-locked' if access_level == :locked}" do %>
            <div class="video-thumb" style="background-image: url('<%= thumb || '' %>');">
              <% unless thumb.present? %>
                <div class="thumb-placeholder">
                  <span class="play-icon">â–¶</span>
                </div>
              <% end %>
              <div class="thumb-overlay">
                <span class="badge badge-neutral"><%= lesson.visibility == "restricted" ? "Private" : lesson.visibility.capitalize %></span>
                <% if access_level == :preview %>
                  <span class="badge badge-warning">Preview</span>
                <% end %>
                <% if access_level == :locked %>
                  <span class="badge badge-warning">Locked</span>
                <% end %>
              </div>
            </div>
            <div class="video-meta">
              <div class="video-title"><%= truncate(lesson.title, length: 70) %></div>
              <div class="video-subtitle">by <%= coach_name %></div>
              <div class="video-info">
                <% if access_level == :preview %>
                  Preview available
                <% elsif lesson.visibility == "free" %>
                  Free
                <% else %>
                  Subscribers
                <% end %>
                <span class="muted">â€¢ <%= time_ago_in_words(lesson.created_at) %> ago</span>
              </div>
              <% if access_level == :preview && lesson.preview_text.present? %>
                <div class="video-snippet"><%= truncate(lesson.preview_text, length: 90) %></div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </section>
    <% end %>
</div>
