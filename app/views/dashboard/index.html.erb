<div class="container">
  <% if current_user.coach? %>
    <header class="page-header">
      <div>
        <h1 class="page-title">Coach dashboard</h1>
        <p class="page-subtitle"><%= current_user.coach_profile&.display_name || current_user.email %></p>
      </div>
      <div class="actions-row">
        <%= link_to "Create new lesson", new_coach_lesson_path, class: "btn btn-primary" %>
        <%= link_to "Manage my lessons", lessons_path, class: "btn btn-secondary" %>
        <% if current_user.coach_profile.present? %>
          <%= link_to "View my public page", coach_path(current_user.coach_profile.slug), class: "btn btn-ghost" %>
        <% end %>
      </div>
    </header>

    <div class="grid-3">
      <div class="card">
        <div class="card-header">
          <span class="muted">Total lessons</span>
          <h3 class="card-title"><%= @lesson_count || 0 %></h3>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="muted">Locked lessons</span>
          <h3 class="card-title">—</h3>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="muted">Subscribers</span>
          <h3 class="card-title"><%= @subscriber_count || 0 %></h3>
        </div>
      </div>
    </div>

    <section class="section">
      <div class="section-header">
        <h2>Recent lessons</h2>
      </div>
      <% if @recent_lessons.present? %>
        <div class="grid">
          <% @recent_lessons.each do |lesson| %>
            <div class="card">
              <h3 class="card-title"><%= lesson.title %></h3>
              <% if lesson.description.present? %>
                <p class="muted"><%= truncate(lesson.description, length: 140) %></p>
                <% end %>
              <div class="card-actions">
                <%= link_to "View", lesson_path(lesson), class: "btn btn-secondary" %>
                <%= link_to "Edit", edit_coach_lesson_path(lesson), class: "btn btn-secondary" %>
                <button type="button"
                        class="btn btn-danger"
                        data-action="confirm-modal#open"
                        data-confirm-title="Delete lesson?"
                        data-confirm-body="This will permanently delete this lesson. This cannot be undone."
                        data-confirm-action="<%= coach_lesson_path(lesson) %>"
                        data-confirm-method="delete"
                        data-confirm-label="Delete">Delete</button>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="card">
          <p class="muted">No lessons yet.</p>
          <div class="card-actions">
            <%= link_to "Create your first lesson", new_coach_lesson_path, class: "btn btn-primary" %>
          </div>
        </div>
      <% end %>
    </section>

  <% else %>
    <section class="card dashboard-hero">
      <div class="dashboard-hero-header">
        <div>
          <p class="muted">Dashboard</p>
          <h1 class="page-title">Welcome back</h1>
          <p class="page-subtitle"><%= current_user.email %></p>
        </div>
        <%= link_to "Refresh", root_path, class: "btn btn-secondary" %>
      </div>

      <div class="dashboard-hero-stats">
        <span class="pill"><%= current_user.role.capitalize %></span>
        <% if current_user.student? %>
          <span class="pill">Subscriptions: <%= @subscription_count || 0 %></span>
        <% end %>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <div>
          <p class="muted">Explore Vaults</p>
          <h2>Featured lessons</h2>
        </div>
      </div>

      <div class="video-grid">
        <% @feed_lessons.each do |lesson| %>
          <% coach_profile = lesson.coach&.coach_profile %>
          <% coach_name = coach_profile&.display_name || lesson.coach&.email || "Coach" %>
          <% access_level = lesson.viewer_access_level(current_user) %>
          <% open_path = if coach_profile&.slug && lesson.respond_to?(:slug) && lesson.slug.present?
                           public_coach_lesson_path(coach_profile.slug, lesson.slug)
                         elsif coach_profile&.slug
                           public_coach_lesson_path(coach_profile.slug, lesson)
                         else
                           lesson_path(lesson)
                         end %>
          <% locked_path = coach_profile&.slug ? coach_path(coach_profile.slug) : coaches_path %>
          <% thumb = lesson_thumbnail_url(lesson) %>
          <%= link_to open_path, class: "video-card #{'video-card-locked' if access_level == :locked}" do %>
            <div class="video-thumb" style="background-image: url('<%= thumb || '' %>');">
              <% unless thumb.present? %>
                <div class="thumb-placeholder">
                  <span class="play-icon">▶</span>
                </div>
              <% end %>
              <div class="thumb-overlay">
                <span class="badge badge-neutral"><%= lesson.visibility == "restricted" ? "Private" : lesson.visibility.capitalize %></span>
                <% if access_level == :preview %>
                  <span class="badge badge-warning">Preview</span>
                <% end %>
                <% if access_level == :locked %>
                  <span class="badge badge-warning">Locked</span>
                <% end %>
              </div>
            </div>
            <div class="video-meta">
              <div class="video-title"><%= truncate(lesson.title, length: 70) %></div>
              <div class="video-subtitle">by <%= coach_name %></div>
              <div class="video-info">
                <% if access_level == :preview %>
                  Preview available
                <% elsif lesson.visibility == "free" %>
                  Free
                <% else %>
                  Subscribers
                <% end %>
                <span class="muted">• <%= time_ago_in_words(lesson.created_at) %> ago</span>
              </div>
              <% if access_level == :preview && lesson.preview_text.present? %>
                <div class="video-snippet"><%= truncate(lesson.preview_text, length: 90) %></div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </section>
    <% end %>
</div>
