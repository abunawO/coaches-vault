<% if selected_category.present? %>
  <div class="mv-card vault-main-card">
    <div class="vault-main__header">
      <div>
        <h3 class="vault-name"><%= selected_category.name %></h3>
        <div class="muted"><%= selected_category.description.presence || "No description provided." %></div>
      </div>
      <div class="vault-main__meta">
        <span class="pill-soft" id="vault_category_count"><%= pluralize(selected_category.lessons.count, "lesson") %></span>
        <button type="button"
                class="icon-btn icon-btn--danger"
                data-action="click->confirm-modal#open"
                data-confirm-title="Delete category?"
                data-confirm-body="This will remove the category and its organization (lessons stay in your library)."
                data-confirm-method="delete"
                data-confirm-url="<%= coach_category_path(selected_category) %>"
                data-tooltip="Delete"
                aria-label="Delete category">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"/></svg>
        </button>
      </div>
    </div>

    <div class="vault-body-grid">
      <div class="vault-panel">
        <div class="vault-panel__header">
          <h4 class="vault-name">In this category</h4>
        </div>
        <% if selected_category.lessons.empty? %>
          <div class="vault-empty mv-card">
            <p class="muted">No lessons yet. Add a few below.</p>
          </div>
        <% else %>
          <div class="vault-lessons">
            <% selected_category.lessons.each do |lesson| %>
              <div class="vault-lesson-row">
                <div>
                  <strong><%= lesson.title %></strong>
                  <% if lesson.description.present? %>
                    <div class="muted"><%= truncate(lesson.description, length: 90) %></div>
                  <% end %>
                </div>
                <div class="vault-lesson-actions">
                  <%= link_to lesson_path(lesson), class: "icon-btn", aria: { label: "Open" }, data: { tooltip: "Open", turbo: false } do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 9s3-6 11-6 11 6 11 6-3 6-11 6S1 9 1 9Z"/><circle cx="12" cy="9" r="2.5"/></svg>
                  <% end %>
                  <%= button_to coach_category_remove_lesson_path(selected_category, lesson_id: lesson.id),
                        method: :delete,
                        form: { class: "inline-form", data: { turbo: false } },
                        data: { turbo_confirm: "Remove lesson from category?", tooltip: "Remove" },
                        class: "icon-btn icon-btn--danger",
                        aria: { label: "Remove" } do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"/></svg>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="vault-panel">
        <div class="vault-panel__header">
          <div>
            <h4 class="vault-name">Add lessons</h4>
            <p class="muted small-text">Select lessons to include.</p>
          </div>
        </div>
        <% category_lesson_ids = selected_category.lesson_ids %>
        <% available_lessons = lessons.where.not(id: category_lesson_ids) %>
        <% if available_lessons.empty? %>
          <div class="vault-empty mv-card">
            <p class="muted">All lessons are already in this category.</p>
          </div>
        <% else %>
          <%= form_with url: coach_category_lessons_path(selected_category), method: :post, data: { controller: "vault-picker" } do |f| %>
            <div class="vault-addlessons">
              <div class="vault-addlessons__top">
                <input type="search"
                       placeholder="Filter lessonsâ€¦"
                       class="input vault-addlessons__search"
                       data-vault-picker-target="search"
                       data-action="input->vault-picker#filter">
                <div class="vault-addlessons__actions">
                  <button type="button" class="link-btn" data-action="vault-picker#selectAll">Select all</button>
                  <button type="button" class="link-btn" data-action="vault-picker#clear">Clear</button>
                </div>
              </div>

              <div class="vault-addlessons__list" data-vault-picker-target="list">
                <% available_lessons.each do |lesson| %>
                  <% searchable = [lesson.title, lesson.description].compact.join(" ") %>
                  <label class="vault-pill"
                         data-vault-picker-target="option"
                         data-search="<%= searchable.downcase %>">
                    <input type="checkbox"
                           name="lesson_ids[]"
                           value="<%= lesson.id %>"
                           data-action="change->vault-picker#updateSubmit"
                           data-vault-picker-target="checkbox">
                    <span class="vault-pill__text"><%= lesson.title %></span>
                  </label>
                <% end %>
              </div>
              <p class="vault-addlessons__empty is-hidden" data-vault-picker-target="empty">No matches.</p>

              <div class="vault-add-actions vault-addlessons__footer">
                <%= submit_tag "Add selected", class: "btn btn-primary btn-small", data: { vault_picker_target: "submit" }, disabled: true %>
                <span class="vault-addlessons__count" data-vault-picker-target="count"></span>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% else %>
  <div class="empty-state empty-state--md">
    <div class="empty-state__icon">ðŸ§ </div>
    <h3 class="empty-state__title">Organize your knowledge</h3>
    <p class="empty-state__body">Create categories to structure your lessons for students.</p>
    <div class="empty-state__actions">
      <button type="button"
              class="btn btn-primary"
              data-action="vault-explorer#toggleCreatePanel">
        Create your first category
      </button>
    </div>
  </div>
<% end %>
