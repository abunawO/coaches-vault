<div class="lesson-form-page">
    <%= form_with model: [:coach, @lesson], local: true, html: { multipart: true, data: { controller: "form-submit-lock", action: "submit->form-submit-lock#handleSubmit turbo:submit-end->form-submit-lock#handleTurboEnd ajax:complete->form-submit-lock#handleAjaxComplete" } } do |form| %>
    <div class="form-submit-lock__overlay" data-form-submit-lock-target="overlay" aria-hidden="true">
        <div class="form-submit-lock__dialog">
            <div class="form-submit-lock__spinner" aria-hidden="true"></div>
            <p class="form-submit-lock__message" data-form-submit-lock-target="overlayMessage">Saving your lesson...</p>
        </div>
    </div>
    <% sticky_error = flash.now[:alert].presence || flash[:alert].presence || @lesson.errors[:base].presence&.first %>
    <% if sticky_error.present? %>
    <div class="form-banner form-banner--error" role="alert">
        <div class="form-banner__icon" aria-hidden="true">‚ö†Ô∏è</div>
        <div class="form-banner__body">
            <p class="form-banner__title">Upload issue</p>
            <p class="form-banner__text"><%= sticky_error %></p>
            <p class="form-banner__hint">Your form entries are still here. Fix the upload below and retry.</p>
        </div>
        <div class="form-banner__actions">
            <a class="btn btn-ghost btn-small" href="#lesson-media-list">Go to uploads</a>
        </div>
    </div>
    <% end %>
    <% if @lesson.errors.any? %>
    <div class="form-alert form-alert--error" role="alert">
        <div class="form-alert__icon" aria-hidden="true">‚ö†Ô∏è</div>
        <div class="form-alert__body">
            <p class="form-alert__title">We couldn't save this lesson yet.</p>
            <p class="form-alert__subtitle">Please review the items below and try again.</p>
            <ul class="form-alert__list">
                <% @lesson.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
                <% end %>
            </ul>
            <p class="form-alert__hint">Common fixes: add at least one media item or video URL, complete required fields, and retry uploads if they failed.</p>
        </div>
        <div class="form-alert__actions">
            <a class="btn btn-ghost btn-small" href="#lesson-media-list">Jump to media</a>
        </div>
    </div>
    <% end %>
    <div class="lesson-form-layout">
        <div class="lesson-form-main">
            <div class="card lesson-form-card">
                <section class="form-section">
                    <div class="section-header">
                        <div>
                            <h3 class="section-title">Basics</h3>
                            <p class="muted small-text">Give your lesson a clear title and description.</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <%= form.label :title %>
                        <%= form.text_field :title, required: true, class: "input", placeholder: "e.g., Distance & Angles 101" %>
                    </div>
                    <div class="form-row">
                        <%= form.label :description %>
                        <%= form.text_area :description, rows: 4, class: "textarea", placeholder: "What students will learn in this lesson..." %>
                    </div>
                </section>

                <section class="form-section">
                    <div class="section-header">
                        <div>
                            <h3 class="section-title">Lesson Content (Carousel)</h3>
                            <p class="muted small-text">Add images or videos as slides. Students will view them in a carousel.</p>
                        </div>
                    </div>

                    <div class="lesson-media-list" id="lesson-media-list">
                        <%= form.fields_for :lesson_media do |mf| %>
                        <% media = mf.object %>
                        <div class="slide-card" data-slide-row>
                            <div class="slide-thumb">
                                <% if media.image? %>
                                <% if media.image_file.attached? %>
                                <%= image_tag(media.image_file.variant(resize_to_limit: [200, 200])) rescue image_tag(media.image_file, style: "max-width: 80px;") %>
                                <% else %>
                                <span class="muted small-text">Image</span>
                                <% end %>
                                <% else %>
                                <div class="thumb-video">Video</div>
                                <% end %>
                            </div>

                            <div class="slide-body">
                                <div class="slide-badge">
                                    <span class="pill-soft"><%= media.kind.capitalize %> slide</span>
                                </div>
                                <div class="slide-fields">
                                    <%= mf.hidden_field :id if media.persisted? %>
                                    <%= mf.hidden_field :kind %>
                                    <%= mf.hidden_field :position, class: "position-field", value: media.position || 0 %>
                                    <% if media.image? %>
                                    <label class="muted small-text">Image file</label>
                                    <%= mf.file_field :image_file, class: "input" %>
                                    <% else %>
                                    <label class="muted small-text">Video URL</label>
                                    <%= mf.text_field :video_url, class: "input", placeholder: "https://www.youtube.com/watch?v=..." %>
                                    <label class="muted small-text" style="margin-top:8px;">Or upload video (MP4/MOV, H.264/AAC, max 2 minutes)</label>
                                    <%= mf.file_field :video_file, class: "input", accept: "video/mp4,video/quicktime", data: { video_multipart_upload: true } %>
                                    <div class="muted small-text upload-status" data-upload-status></div>
                                    <p class="muted small-text">Use a YouTube/Vimeo URL OR upload an MP4 or MOV (H.264/AAC) file under 2 minutes.</p>
                                    <% end %>
                                </div>
                            </div>

                            <div class="slide-controls">
                                <button type="button" class="icon-btn" data-move="up" aria-label="Move up">‚Üë</button>
                                <button type="button" class="icon-btn" data-move="down" aria-label="Move down">‚Üì</button>
                                <button type="button" class="icon-btn icon-btn--danger" data-remove-row aria-label="Remove slide">üóë</button>
                                <%= mf.check_box :_destroy, style: "display:none;", data: { destroy_field: true } %>
                            </div>
                        </div>
                        <% end %>
                    </div>

                    <div class="lesson-media-actions-row">
                        <button type="button" class="btn btn-secondary btn-small" data-action="click" data-add-media="image">+ Add image slide</button>
                        <button type="button" class="btn btn-secondary btn-small" data-action="click" data-add-media="video">+ Add video slide</button>
                        <p class="muted small-text" id="slide-limit-message" style="margin:0;">You can add up to 5 slides per lesson.</p>
                    </div>

                    <div class="draft-slide card" id="draft-slide" hidden>
                        <div class="draft-slide__header">
                            <h4>New slide</h4>
                            <button type="button" class="icon-btn" id="draft-close" aria-label="Close draft">√ó</button>
                        </div>
                        <div class="draft-slide__body">
                            <div class="draft-image" id="draft-image" hidden>
                                <label class="muted small-text">Image file</label>
                                <input type="file" class="input" id="draft-image-input" />
                            </div>
                            <div class="draft-video" id="draft-video" hidden>
                                <label class="muted small-text">Video URL</label>
                                <input type="text" class="input" id="draft-video-input" placeholder="https://www.youtube.com/watch?v=..." />
                                <label class="muted small-text" style="margin-top:8px;">Or upload video</label>
                                <input type="file" class="input" id="draft-video-file-input" accept="video/mp4,video/quicktime" data-video-multipart-upload="true" />
                                <div class="muted small-text upload-status" data-upload-status></div>
                                <p class="muted small-text">Use a YouTube/Vimeo URL OR upload an MP4/MOV file.</p>
                            </div>
                        </div>
                        <div class="draft-slide__footer">
                            <button type="button" class="btn btn-ghost btn-small" id="draft-cancel">Cancel</button>
                            <button type="button" class="btn btn-primary btn-small" id="draft-add">Add slide</button>
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <div class="section-header">
                        <div>
                            <h3 class="section-title">Preview</h3>
                            <p class="muted small-text">Add a teaser for unsubscribed viewers (Subscribers visibility only).</p>
                        </div>
                    </div>
                    <div id="preview-fields" style="<%= (@lesson.visibility == "subscribers") ? '' : 'display:none;' %>">
                        <label class="radio-row">
                            <%= form.check_box :preview, { checked: @lesson.preview?, data: { action: "change->preview-toggle#toggle" } }, true, false %>
                            <span>Enable preview (teaser for unsubscribed viewers)</span>
                        </label>
                        <div class="form-row" id="preview-text-row" style="<%= (@lesson.preview? && @lesson.visibility == "subscribers") ? '' : 'display:none;' %>">
                            <%= form.label :preview_text, "Preview text" %>
                            <%= form.text_area :preview_text, rows: 3, class: "textarea", placeholder: "Short teaser shown to unsubscribed viewers." %>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <aside class="lesson-form-sidebar sticky-sidebar">
            <div class="card lesson-form-card">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">Visibility</h3>
                        <p class="muted small-text">Choose who can view this lesson.</p>
                    </div>
                </div>
                <div class="visibility-options">
                    <label class="visibility-card">
                        <%= form.radio_button :visibility, "free", checked: @lesson.visibility == "free", class: "vis-radio" %>
                        <div class="visibility-card__body">
                            <div class="visibility-card__title">Free</div>
                            <div class="muted small-text">Visible to all logged-in users.</div>
                        </div>
                        <span class="checkmark" aria-hidden="true">‚úì</span>
                    </label>
                    <label class="visibility-card">
                        <%= form.radio_button :visibility, "subscribers", checked: @lesson.visibility == "subscribers", class: "vis-radio" %>
                        <div class="visibility-card__body">
                            <div class="visibility-card__title">Subscribers</div>
                            <div class="muted small-text">All active subscribers can view.</div>
                        </div>
                        <span class="checkmark" aria-hidden="true">‚úì</span>
                    </label>
                    <label class="visibility-card">
                        <%= form.radio_button :visibility, "restricted", checked: @lesson.visibility == "restricted", class: "vis-radio" %>
                        <div class="visibility-card__body">
                            <div class="visibility-card__title">Private</div>
                            <div class="muted small-text">Only selected subscribers can view.</div>
                        </div>
                        <span class="checkmark" aria-hidden="true">‚úì</span>
                    </label>
                </div>
                <p class="muted small-text" id="private-note-new" style="<%= @lesson.restricted? ? '' : 'display:none;' %>">Only selected subscribers can watch this lesson.</p>

                <div class="subscriber-picker" id="selected-wrapper-new" style="<%= @lesson.restricted? ? '' : 'display:none;' %>">
                    <div class="section-header">
                        <div>
                            <h4 class="section-title">Allowed subscribers</h4>
                            <p class="muted small-text">Choose which active subscribers can view this private lesson.</p>
                        </div>
                        <span class="pill-soft" id="selected-count-new"></span>
                    </div>
                    <div class="access-filter">
                        <input type="text" id="subscriber-search-new" class="input" placeholder="Search subscribers..." />
                        <div class="card-actions" style="margin:0;">
                            <button type="button" class="btn btn-ghost btn-small" id="select-all-btn-new">Select all</button>
                            <button type="button" class="btn btn-ghost btn-small" id="clear-all-btn-new">Clear</button>
                        </div>
                    </div>
                    <div class="subscriber-list">
                        <% if @subscribers.empty? %>
                        <div class="empty-state">No active subscribers to share with.</div>
                        <% else %>
                        <% preselected = @preselected_allowed_ids || [] %>
                        <% @subscribers.each do |sub| %>
                        <% profile = sub.student_profile %>
                        <% name = profile&.display_name.presence || sub.email %>
                        <% initials = name.to_s.strip.first(2).presence || sub.email.to_s.first(2) %>
                        <% location = profile&.location.presence %>
                        <label class="subscriber-card subscriber-access-new" data-email="<%= sub.email.downcase %>">
                            <input type="checkbox" name="lesson[allowed_subscriber_ids][]" value="<%= sub.id %>" <%= "checked" if preselected.include?(sub.id) %> />
                            <div class="subscriber-left">
                                <div class="avatar-circle avatar-circle--lg">
                                    <% if profile&.avatar&.attached? %>
                                        <% begin %>
                                            <%= image_tag url_for(profile.avatar.variant(resize_to_fill: [48, 48])), alt: name, class: "avatar-img" %>
                                        <% rescue StandardError %>
                                            <%= image_tag url_for(profile.avatar), alt: name, class: "avatar-img" %>
                                        <% end %>
                                    <% else %>
                                        <span class="avatar-fallback"><%= initials.upcase %></span>
                                    <% end %>
                                </div>
                                <div class="subscriber-meta">
                                    <div class="subscriber-name"><%= name %></div>
                                    <% if location.present? %>
                                        <div class="muted small-text"><%= location %></div>
                                    <% end %>
                                    <div class="muted small-text">Active subscriber</div>
                                </div>
                            </div>
                            <span class="pill-soft selected-pill">Selected</span>
                        </label>
                        <% end %>
                        <% end %>
                    </div>
                    <div class="access-disabled-overlay" id="access-disabled-overlay-new" style="<%= @lesson.restricted? ? 'display:none;' : '' %>">
                        <p class="muted">Subscriber selection is available when ‚ÄúPrivate‚Äù is chosen.</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <div class="access-footer card sticky-save lesson-form-actions">
        <div class="muted small-text" id="dirty-indicator-new">Changes are saved when you click Save.</div>
        <div class="card-actions">
            <div class="form-submit-lock__status" style="display:inline-flex; align-items:center; gap:8px; margin-right:12px;">
                <span data-form-submit-lock-target="status" class="muted small-text" style="display:none;"></span>
                <span data-form-submit-lock-target="error" class="small-text" style="display:none; color:#dc2626;"></span>
            </div>
            <%= form.submit(@lesson.persisted? ? "Update lesson" : "Create lesson", class: "btn btn-primary", data: { form_submit_lock_target: "submit" }) %>
            <%= link_to "Cancel", coach_lessons_path, class: "btn btn-ghost", data: { form_submit_lock_target: "cancel", action: "click->form-submit-lock#handleCancelClick" } %>
        </div>
    </div>
    <% end %>
</div>

<script>
    document.addEventListener("turbo:load", () => {
        const root = document.querySelector(".lesson-form-page");
        if (!root) return;
        if (root.dataset.mediaInit === "true") return;
        root.dataset.mediaInit = "true";
        const visibilityRadios = document.querySelectorAll("input[name='lesson[visibility]']");
        const previewWrap = document.getElementById("preview-fields");
        const previewCheckbox = document.querySelector("input[name='lesson[preview]']");
        const previewTextRow = document.getElementById("preview-text-row");
        const privateNote = document.getElementById("private-note-new");
        const selectedWrapper = document.getElementById("selected-wrapper-new");
        const disabledOverlay = document.getElementById("access-disabled-overlay-new");
        const search = document.getElementById("subscriber-search-new");
        const rows = Array.from(document.querySelectorAll(".subscriber-access-new"));
        const selectAllBtn = document.getElementById("select-all-btn-new");
        const clearAllBtn = document.getElementById("clear-all-btn-new");
        const selectedCount = document.getElementById("selected-count-new");
        const form = document.querySelector(".lesson-form-page form");
        const dirtyIndicator = document.getElementById("dirty-indicator-new");

        function togglePreviewVisibility() {
            const val = document.querySelector("input[name='lesson[visibility]']:checked")?.value;
            if (val === "subscribers") {
                previewWrap.style.display = "";
            } else {
                previewWrap.style.display = "none";
            }
        }

        function togglePreviewText() {
            previewTextRow.style.display = (previewCheckbox && previewCheckbox.checked) ? "" : "none";
        }

        function toggleVisibility() {
            const val = document.querySelector("input[name='lesson[visibility]']:checked")?.value;
            const isRestricted = val === "restricted";
            selectedWrapper.style.display = isRestricted ? "" : "none";
            disabledOverlay.style.display = isRestricted ? "none" : "";
            if (privateNote) privateNote.style.display = isRestricted ? "" : "none";
            const disabled = !isRestricted;
            rows.forEach((row) => {
                const cb = row.querySelector("input[type='checkbox']");
                if (cb) cb.disabled = disabled;
                row.classList.toggle("disabled", disabled);
            });
            updateCount();
        }

        visibilityRadios.forEach((r) => r.addEventListener("change", () => {
            toggleVisibility();
            togglePreviewVisibility();
            markDirty();
        }));
        previewCheckbox?.addEventListener("change", () => {
            togglePreviewText();
            markDirty();
        });

        search?.addEventListener("input", (e) => {
            const q = e.target.value.toLowerCase();
            rows.forEach((row) => {
                const email = row.dataset.email || "";
                row.style.display = email.includes(q) ? "" : "none";
            });
        });

        function updateCount() {
            const checked = rows.filter((row) => row.querySelector("input[type='checkbox']")?.checked);
            if (selectedCount) selectedCount.textContent = `${checked.length} selected`;
            if (clearAllBtn) clearAllBtn.style.visibility = checked.length > 0 ? "visible" : "hidden";
        }

        rows.forEach((row) => {
            const cb = row.querySelector("input[type='checkbox']");
            cb?.addEventListener("change", () => {
                updateCount();
                markDirty();
            });
        });

        selectAllBtn?.addEventListener("click", () => {
            rows.forEach((row) => {
                const cb = row.querySelector("input[type='checkbox']");
                if (cb) cb.checked = true;
            });
            updateCount();
            markDirty();
        });

        clearAllBtn?.addEventListener("click", () => {
            rows.forEach((row) => {
                const cb = row.querySelector("input[type='checkbox']");
                if (cb) cb.checked = false;
            });
            updateCount();
            markDirty();
        });

        // dirty state
        let initialSnapshot = form ? new FormData(form) : null;

        function isDirty() {
            if (!form || !initialSnapshot) return false;
            const current = new FormData(form);
            const keys = Array.from(new Set([...initialSnapshot.keys(), ...current.keys()]));
            for (const k of keys) {
                if (current.getAll(k).sort().join(",") !== initialSnapshot.getAll(k).sort().join(",")) return true;
            }
            return false;
        }

        function markDirty() {
            if (!dirtyIndicator) return;
            dirtyIndicator.textContent = isDirty() ? "Unsaved changes" : "Changes are saved when you click Save.";
        }

        toggleVisibility();
        togglePreviewVisibility();
        togglePreviewText();
        updateCount();
        markDirty();
        form?.addEventListener("change", markDirty);

        // ---- Lesson media (slides) ----
        const mediaList = document.getElementById("lesson-media-list");
        const addButtons = Array.from(document.querySelectorAll("[data-add-media]"));
        const slideLimitMessage = document.getElementById("slide-limit-message");
        const MAX_SLIDES = 5;
        const draft = document.getElementById("draft-slide");
        const draftImageWrap = document.getElementById("draft-image");
        const draftVideoWrap = document.getElementById("draft-video");
        let draftImageInput = document.getElementById("draft-image-input");
        const draftVideoInput = document.getElementById("draft-video-input");
        let draftVideoFileInput = document.getElementById("draft-video-file-input");
        const draftClose = document.getElementById("draft-close");
        const draftCancel = document.getElementById("draft-cancel");
        const draftAdd = document.getElementById("draft-add");
        let draftKind = null;

        const mediaTemplate = (kind, index) => {
            const positionField = `<input type=\"hidden\" name=\"lesson[lesson_media_attributes][${index}][position]\" class=\"position-field\" value=\"0\" />`;
            if (kind === "image") {
                return `
          <div class=\"slide-card\" data-slide-row>
            <div class=\"slide-thumb\">
              <div class=\"thumb-video\">Image</div>
            </div>
            <div class=\"slide-body\">
              <div class=\"slide-badge\">
                <span class=\"pill-soft\">Image slide</span>
              </div>
              <div class=\"slide-fields\">
                <input type=\"hidden\" name=\"lesson[lesson_media_attributes][${index}][kind]\" value=\"image\" />
                ${positionField}
                <label class=\"muted small-text\">Image file</label>
                <input type=\"file\" name=\"lesson[lesson_media_attributes][${index}][image_file]\" class=\"input\" />
              </div>
            </div>
            <div class=\"slide-controls\">
              <button type=\"button\" class=\"icon-btn\" data-move=\"up\" aria-label=\"Move up\">‚Üë</button>
              <button type=\"button\" class=\"icon-btn\" data-move=\"down\" aria-label=\"Move down\">‚Üì</button>
              <button type=\"button\" class=\"icon-btn icon-btn--danger\" data-remove-row aria-label=\"Remove slide\">üóë</button>
              <input type=\"checkbox\" name=\"lesson[lesson_media_attributes][${index}][_destroy]\" style=\"display:none;\" data-destroy-field=\"true\" />
            </div>
          </div>
        `;
            }
            return `
        <div class=\"slide-card\" data-slide-row>
          <div class=\"slide-thumb\">
            <div class=\"thumb-video\">Video</div>
          </div>
          <div class=\"slide-body\">
            <div class=\"slide-badge\">
              <span class=\"pill-soft\">Video slide</span>
            </div>
            <div class=\"slide-fields\">
              <input type=\"hidden\" name=\"lesson[lesson_media_attributes][${index}][kind]\" value=\"video\" />
              ${positionField}
              <label class=\"muted small-text\">Video URL</label>
              <input type=\"text\" name=\"lesson[lesson_media_attributes][${index}][video_url]\" class=\"input\" placeholder=\"https://www.youtube.com/watch?v=...\" />
              <label class=\"muted small-text\" style=\"margin-top:8px;\">Or upload video</label>
              <input type=\"file\" name=\"lesson[lesson_media_attributes][${index}][video_file]\" class=\"input\" accept=\"video/mp4,video/quicktime\" data-video-multipart-upload=\"true\" />
              <div class=\"muted small-text upload-status\" data-upload-status></div>
              <p class=\"muted small-text\">Use a YouTube/Vimeo URL OR upload an MP4/MOV file.</p>
            </div>
          </div>
          <div class=\"slide-controls\">
            <button type=\"button\" class=\"icon-btn\" data-move=\"up\" aria-label=\"Move up\">‚Üë</button>
            <button type=\"button\" class=\"icon-btn\" data-move=\"down\" aria-label=\"Move down\">‚Üì</button>
            <button type=\"button\" class=\"icon-btn icon-btn--danger\" data-remove-row aria-label=\"Remove slide\">üóë</button>
            <input type=\"checkbox\" name=\"lesson[lesson_media_attributes][${index}][_destroy]\" style=\"display:none;\" data-destroy-field=\"true\" />
          </div>
        </div>
      `;
        };

        const reindexPositions = () => {
            if (!mediaList) return;
            const rows = Array.from(mediaList.querySelectorAll("[data-slide-row]"));
            rows.forEach((row, idx) => {
                const posField = row.querySelector(".position-field");
                if (posField) posField.value = idx;
            });
        };

        const currentSlidesCount = () => {
            if (!mediaList) return 0;
            return Array.from(mediaList.querySelectorAll("[data-slide-row]")).filter((row) => {
                if (row.classList.contains("is-destroyed")) return false;
                const destroyField = row.querySelector("[data-destroy-field]");
                return !(destroyField && destroyField.checked);
            }).length;
        };

        const updateSlideLimitState = () => {
            const count = currentSlidesCount();
            const limitReached = count >= MAX_SLIDES;
            addButtons.forEach((btn) => {
                btn.disabled = limitReached;
            });
            if (slideLimitMessage) {
                slideLimitMessage.textContent = limitReached
                    ? "Slide limit reached (5). Remove a slide to add another."
                    : "You can add up to 5 slides per lesson.";
            }
        };

        const attachRowHandlers = (row, isNew = false) => {
            const up = row.querySelector("[data-move='up']");
            const down = row.querySelector("[data-move='down']");
            const removeBtn = row.querySelector("[data-remove-row]");
            const destroyField = row.querySelector("[data-destroy-field]");

            up?.addEventListener("click", () => {
                const prev = row.previousElementSibling;
                if (prev) {
                    mediaList.insertBefore(row, prev);
                    reindexPositions();
                    markDirty();
                }
            });

            down?.addEventListener("click", () => {
                const next = row.nextElementSibling;
                if (next) {
                    mediaList.insertBefore(next, row);
                    reindexPositions();
                    markDirty();
                }
            });

            removeBtn?.addEventListener("click", () => {
                if (destroyField) {
                    destroyField.checked = true;
                    destroyField.value = "1";
                    row.classList.add("is-destroyed");
                } else if (isNew) {
                    row.remove();
                } else {
                    row.classList.add("is-destroyed");
                }
                reindexPositions();
                updateSlideLimitState();
                markDirty();
            });
        };

        // attach to existing rows
        Array.from(mediaList?.querySelectorAll("[data-slide-row]") || []).forEach((row) => attachRowHandlers(row));

        const resetDraft = () => {
            draftKind = null;
            draftImageWrap.hidden = true;
            draftVideoWrap.hidden = true;
            if (draftImageInput) draftImageInput.value = "";
            if (draftVideoInput) draftVideoInput.value = "";
            if (draftVideoFileInput) draftVideoFileInput.value = "";
            draft.hidden = true;
        };

        const openDraft = (kind) => {
            draftKind = kind;
            draft.hidden = false;
            draftImageWrap.hidden = kind !== "image";
            draftVideoWrap.hidden = kind !== "video";
            if (kind === "image") {
                draftVideoInput.value = "";
                draftImageInput.value = "";
                draftImageInput?.focus();
            } else {
                draftImageInput.value = "";
                draftVideoInput.value = "";
                draftVideoFileInput.value = "";
                draftVideoInput?.focus();
            }
        };

        addButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                if (currentSlidesCount() >= MAX_SLIDES) {
                    updateSlideLimitState();
                    return;
                }
                openDraft(btn.dataset.addMedia);
            });
        });

        const closeDraft = () => resetDraft();
        draftClose?.addEventListener("click", closeDraft);
        draftCancel?.addEventListener("click", closeDraft);
        if (!window.__lessonDraftEscapeBound) {
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && draft && !draft.hidden) closeDraft();
            });
            window.__lessonDraftEscapeBound = true;
        }

        draftAdd?.addEventListener("click", () => {
            if (!draftKind || !mediaList) return;
            if (draftKind === "image" && (!draftImageInput || !draftImageInput.files.length)) return;
            const urlVal = draftVideoInput ? draftVideoInput.value.trim() : "";
            const hasVideoFile = draftVideoFileInput && draftVideoFileInput.files.length > 0;
            if (draftKind === "video" && !hasVideoFile && urlVal === "") return;
            if (currentSlidesCount() >= MAX_SLIDES) {
                updateSlideLimitState();
                return;
            }

            const index = Date.now();
            mediaList.insertAdjacentHTML("beforeend", mediaTemplate(draftKind, index));
            const newRow = mediaList.lastElementChild;

            if (draftKind === "image") {
                // Move the actual file input into the new row so the file is submitted
                const target = newRow.querySelector("input[type='file']");
                if (target && draftImageInput) {
                    draftImageInput.name = target.name;
                    target.replaceWith(draftImageInput);
                    // recreate a fresh draft input for future use
                    const fresh = document.createElement("input");
                    fresh.type = "file";
                    fresh.className = "input";
                    fresh.id = "draft-image-input";
                    draftImageInput = fresh;
                    const draftImageParent = draftImageWrap;
                    draftImageParent?.querySelector("input[type='file']")?.remove();
                    draftImageParent?.appendChild(fresh);
                }
            } else {
                const targetUrl = newRow.querySelector("input[type='text']");
                const targetFile = newRow.querySelector("input[type='file']");
                if (hasVideoFile && targetFile && draftVideoFileInput) {
                    draftVideoFileInput.name = targetFile.name;
                    targetFile.replaceWith(draftVideoFileInput);
                    if (targetUrl) targetUrl.value = "";
                    const freshVideoFile = document.createElement("input");
                    freshVideoFile.type = "file";
                    freshVideoFile.className = "input";
                    freshVideoFile.id = "draft-video-file-input";
                    freshVideoFile.accept = "video/mp4,video/quicktime";
                    freshVideoFile.setAttribute("data-video-multipart-upload", "true");
                    draftVideoFileInput = freshVideoFile;
                    const draftVideoParent = draftVideoWrap;
                    draftVideoParent?.querySelector("input[type='file']")?.remove();
                    draftVideoParent?.appendChild(freshVideoFile);
                } else if (targetUrl) {
                    targetUrl.value = urlVal;
                }
            }

            attachRowHandlers(newRow, true);
            window.initVideoMultipartUploads?.(newRow);
            reindexPositions();
            closeDraft();
            markDirty();
        });

        reindexPositions();
        updateSlideLimitState();
    });
</script>
