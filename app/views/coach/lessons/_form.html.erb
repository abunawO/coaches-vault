<div class="lesson-form-page">
    <%= form_with model: [:coach, @lesson], local: true, html: { multipart: true, data: { controller: "form-submit-lock lesson-form", action: "submit->form-submit-lock#handleSubmit turbo:submit-end->form-submit-lock#handleTurboEnd ajax:complete->form-submit-lock#handleAjaxComplete" } } do |form| %>
    <div class="form-submit-lock__overlay" data-form-submit-lock-target="overlay" aria-hidden="true">
        <div class="form-submit-lock__dialog">
            <div class="form-submit-lock__spinner" aria-hidden="true"></div>
            <p class="form-submit-lock__message" data-form-submit-lock-target="overlayMessage">Saving your lesson...</p>
        </div>
    </div>
    <% sticky_error = flash.now[:alert].presence || flash[:alert].presence || @lesson.errors[:base].presence&.first %>
    <% if sticky_error.present? %>
    <div class="form-banner form-banner--error" role="alert">
        <div class="form-banner__icon" aria-hidden="true">‚ö†Ô∏è</div>
        <div class="form-banner__body">
            <p class="form-banner__title">Upload issue</p>
            <p class="form-banner__text"><%= sticky_error %></p>
            <p class="form-banner__hint">Your form entries are still here. Fix the upload below and retry.</p>
        </div>
        <div class="form-banner__actions">
            <a class="btn btn-ghost btn-small" href="#lesson-media-list">Go to uploads</a>
        </div>
    </div>
    <% end %>
    <% if @lesson.errors.any? %>
    <div class="form-alert form-alert--error" role="alert">
        <div class="form-alert__icon" aria-hidden="true">‚ö†Ô∏è</div>
        <div class="form-alert__body">
            <p class="form-alert__title">We couldn't save this lesson yet.</p>
            <p class="form-alert__subtitle">Please review the items below and try again.</p>
            <ul class="form-alert__list">
                <% @lesson.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
                <% end %>
            </ul>
            <p class="form-alert__hint">Common fixes: add at least one media item or video URL, complete required fields, and retry uploads if they failed.</p>
        </div>
        <div class="form-alert__actions">
            <a class="btn btn-ghost btn-small" href="#lesson-media-list">Jump to media</a>
        </div>
    </div>
    <% end %>
    <div class="lesson-form-layout">
        <div class="lesson-form-main">
            <div class="card lesson-form-card">
                <section class="form-section">
                    <div class="section-header">
                        <div>
                            <h3 class="section-title">Basics</h3>
                            <p class="muted small-text">Give your lesson a clear title and description.</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <%= form.label :title %>
                        <%= form.text_field :title, required: true, class: "input", placeholder: "e.g., Distance & Angles 101" %>
                    </div>
                    <div class="form-row">
                        <%= form.label :description %>
                        <%= form.text_area :description, rows: 4, class: "textarea", placeholder: "What students will learn in this lesson..." %>
                    </div>
                    <div class="form-row">
                        <%= form.label :cover_image, "Cover image (optional)" %>
                        <p class="muted small-text" style="margin:0 0 8px 0;">Shown in dashboard and feed cards.</p>
                        <%= form.file_field :cover_image, class: "input", accept: "image/png,image/jpeg,image/webp,image/*" %>
                        <% if @lesson.cover_image.attached? %>
                        <div style="margin-top:10px; display:grid; gap:8px;">
                            <%= image_tag url_for(@lesson.cover_image.variant(resize_to_limit: [600, 338])), alt: "Current cover image", style: "width: 220px; aspect-ratio: 16 / 9; object-fit: cover; border-radius: 10px; border: 1px solid #e5e7eb;" %>
                            <label class="muted small-text" style="display:flex; align-items:center; gap:8px;">
                                <%= check_box_tag "lesson[remove_cover_image]", "1", false %>
                                Remove current cover image
                            </label>
                        </div>
                        <% end %>
                    </div>
                </section>

                <section class="form-section">
                    <div class="section-header">
                        <div>
                            <h3 class="section-title">Lesson Content (Carousel)</h3>
                            <p class="muted small-text">Add images or videos as slides. Students will view them in a carousel.</p>
                        </div>
                    </div>

                    <div class="lesson-media-list" id="lesson-media-list">
                        <%= form.fields_for :lesson_media do |mf| %>
                        <% media = mf.object %>
                        <div class="slide-card" data-slide-row>
                            <div class="slide-thumb">
                                <% if media.image? %>
                                <% if media.image_file.attached? %>
                                <%= image_tag(media.image_file.variant(resize_to_limit: [200, 200])) rescue image_tag(media.image_file, style: "max-width: 80px;") %>
                                <% else %>
                                <span class="muted small-text">Image</span>
                                <% end %>
                                <% else %>
                                <div class="thumb-video">Video</div>
                                <% end %>
                            </div>

                            <div class="slide-body">
                                <div class="slide-badge">
                                    <span class="pill-soft"><%= media.kind.capitalize %> slide</span>
                                </div>
                                <div class="slide-fields">
                                    <%= mf.hidden_field :id if media.persisted? %>
                                    <%= mf.hidden_field :kind %>
                                    <%= mf.hidden_field :position, class: "position-field", value: media.position || 0 %>
                                    <% if media.image? %>
                                    <label class="muted small-text">Image file</label>
                                    <%= mf.file_field :image_file, class: "input" %>
                                    <% else %>
                                    <label class="muted small-text">Video URL</label>
                                    <%= mf.text_field :video_url, class: "input", placeholder: "https://www.youtube.com/watch?v=..." %>
                                    <label class="muted small-text" style="margin-top:8px;">Or upload video (MP4/MOV, H.264/AAC, max 2 minutes)</label>
                                    <%= mf.file_field :video_file, class: "input", accept: "video/mp4,video/quicktime", data: { video_multipart_upload: true } %>
                                    <div class="muted small-text upload-status" data-upload-status></div>
                                    <p class="muted small-text">Use a YouTube/Vimeo URL OR upload an MP4 or MOV (H.264/AAC) file under 2 minutes.</p>
                                    <% end %>
                                </div>
                            </div>

                            <div class="slide-controls">
                                <button type="button" class="icon-btn" data-move="up" aria-label="Move up">‚Üë</button>
                                <button type="button" class="icon-btn" data-move="down" aria-label="Move down">‚Üì</button>
                                <button type="button" class="icon-btn icon-btn--danger" data-remove-row aria-label="Remove slide">üóë</button>
                                <%= mf.check_box :_destroy, style: "display:none;", data: { destroy_field: true } %>
                            </div>
                        </div>
                        <% end %>
                    </div>

                    <div class="lesson-media-actions-row">
                        <button type="button" class="btn btn-secondary btn-small" data-add-media="image">+ Add image slide</button>
                        <button type="button" class="btn btn-secondary btn-small" data-add-media="video">+ Add video slide</button>
                        <button type="button" class="btn btn-ghost btn-small" data-bulk-add-button>Bulk add media</button>
                        <input type="file"
                            id="bulk-media-file-input"
                            hidden
                            multiple
                            accept="image/*,video/mp4,video/quicktime"
                            data-bulk-file-input />
                        <p class="muted small-text" id="slide-limit-message" style="margin:0;">You can add up to 5 slides per lesson.</p>
                    </div>
                    <div class="lesson-media-bulk">
                        <button type="button" class="lesson-media-dropzone" data-bulk-dropzone>
                            <span class="lesson-media-dropzone__title">Bulk add media</span>
                            <span class="lesson-media-dropzone__hint">Select up to 5 files (images + MP4/MOV videos)</span>
                        </button>
                        <p class="muted small-text lesson-media-bulk__usage" data-bulk-usage></p>
                        <p class="muted small-text lesson-media-bulk__feedback" data-bulk-feedback aria-live="polite"></p>
                    </div>

                    <div class="draft-slide card" id="draft-slide" hidden>
                        <div class="draft-slide__header">
                            <h4>New slide</h4>
                            <button type="button" class="icon-btn" id="draft-close" aria-label="Close draft">√ó</button>
                        </div>
                        <div class="draft-slide__body">
                            <div class="draft-image" id="draft-image" hidden>
                                <label class="muted small-text">Image file</label>
                                <input type="file" class="input" id="draft-image-input" />
                            </div>
                            <div class="draft-video" id="draft-video" hidden>
                                <label class="muted small-text">Video URL</label>
                                <input type="text" class="input" id="draft-video-input" placeholder="https://www.youtube.com/watch?v=..." />
                                <label class="muted small-text" style="margin-top:8px;">Or upload video</label>
                                <input type="file" class="input" id="draft-video-file-input" accept="video/mp4,video/quicktime" data-video-multipart-upload="true" />
                                <div class="muted small-text upload-status" data-upload-status></div>
                                <p class="muted small-text">Use a YouTube/Vimeo URL OR upload an MP4/MOV file.</p>
                            </div>
                        </div>
                        <div class="draft-slide__footer">
                            <button type="button" class="btn btn-ghost btn-small" id="draft-cancel">Cancel</button>
                            <button type="button" class="btn btn-primary btn-small" id="draft-add">Add slide</button>
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <div class="section-header">
                        <div>
                            <h3 class="section-title">Preview</h3>
                            <p class="muted small-text">Add a teaser for unsubscribed viewers (Subscribers visibility only).</p>
                        </div>
                    </div>
                    <div id="preview-fields" style="<%= (@lesson.visibility == "subscribers") ? '' : 'display:none;' %>">
                        <label class="radio-row">
                            <%= form.check_box :preview, { checked: @lesson.preview?, data: { action: "change->preview-toggle#toggle" } }, true, false %>
                            <span>Enable preview (teaser for unsubscribed viewers)</span>
                        </label>
                        <div class="form-row" id="preview-text-row" style="<%= (@lesson.preview? && @lesson.visibility == "subscribers") ? '' : 'display:none;' %>">
                            <%= form.label :preview_text, "Preview text" %>
                            <%= form.text_area :preview_text, rows: 3, class: "textarea", placeholder: "Short teaser shown to unsubscribed viewers." %>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <aside class="lesson-form-sidebar sticky-sidebar">
            <div class="card lesson-form-card">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">Visibility</h3>
                        <p class="muted small-text">Choose who can view this lesson.</p>
                    </div>
                </div>
                <div class="visibility-options">
                    <label class="visibility-card">
                        <%= form.radio_button :visibility, "free", checked: @lesson.visibility == "free", class: "vis-radio" %>
                        <div class="visibility-card__body">
                            <div class="visibility-card__title">Free</div>
                            <div class="muted small-text">Visible to all logged-in users.</div>
                        </div>
                        <span class="checkmark" aria-hidden="true">‚úì</span>
                    </label>
                    <label class="visibility-card">
                        <%= form.radio_button :visibility, "subscribers", checked: @lesson.visibility == "subscribers", class: "vis-radio" %>
                        <div class="visibility-card__body">
                            <div class="visibility-card__title">Subscribers</div>
                            <div class="muted small-text">All active subscribers can view.</div>
                        </div>
                        <span class="checkmark" aria-hidden="true">‚úì</span>
                    </label>
                    <label class="visibility-card">
                        <%= form.radio_button :visibility, "restricted", checked: @lesson.visibility == "restricted", class: "vis-radio" %>
                        <div class="visibility-card__body">
                            <div class="visibility-card__title">Private</div>
                            <div class="muted small-text">Only selected subscribers can view.</div>
                        </div>
                        <span class="checkmark" aria-hidden="true">‚úì</span>
                    </label>
                </div>
                <p class="muted small-text" id="private-note-new" style="<%= @lesson.restricted? ? '' : 'display:none;' %>">Only selected subscribers can watch this lesson.</p>

                <div class="subscriber-picker" id="selected-wrapper-new" style="<%= @lesson.restricted? ? '' : 'display:none;' %>">
                    <div class="section-header">
                        <div>
                            <h4 class="section-title">Allowed subscribers</h4>
                            <p class="muted small-text">Choose which active subscribers can view this private lesson.</p>
                        </div>
                        <span class="pill-soft" id="selected-count-new"></span>
                    </div>
                    <div class="access-filter">
                        <input type="text" id="subscriber-search-new" class="input" placeholder="Search subscribers..." />
                        <div class="card-actions" style="margin:0;">
                            <button type="button" class="btn btn-ghost btn-small" id="select-all-btn-new">Select all</button>
                            <button type="button" class="btn btn-ghost btn-small" id="clear-all-btn-new">Clear</button>
                        </div>
                    </div>
                    <div class="subscriber-list">
                        <% if @subscribers.empty? %>
                        <div class="empty-state">No active subscribers to share with.</div>
                        <% else %>
                        <% preselected = @preselected_allowed_ids || [] %>
                        <% @subscribers.each do |sub| %>
                        <% profile = sub.student_profile %>
                        <% name = profile&.display_name.presence || sub.email %>
                        <% initials = name.to_s.strip.first(2).presence || sub.email.to_s.first(2) %>
                        <% location = profile&.location.presence %>
                        <label class="subscriber-card subscriber-access-new" data-email="<%= sub.email.downcase %>">
                            <input type="checkbox" name="lesson[allowed_subscriber_ids][]" value="<%= sub.id %>" <%= "checked" if preselected.include?(sub.id) %> />
                            <div class="subscriber-left">
                                <div class="avatar-circle avatar-circle--lg">
                                    <% if profile&.avatar&.attached? %>
                                        <% begin %>
                                            <%= image_tag url_for(profile.avatar.variant(resize_to_fill: [48, 48])), alt: name, class: "avatar-img" %>
                                        <% rescue StandardError %>
                                            <%= image_tag url_for(profile.avatar), alt: name, class: "avatar-img" %>
                                        <% end %>
                                    <% else %>
                                        <span class="avatar-fallback"><%= initials.upcase %></span>
                                    <% end %>
                                </div>
                                <div class="subscriber-meta">
                                    <div class="subscriber-name"><%= name %></div>
                                    <% if location.present? %>
                                        <div class="muted small-text"><%= location %></div>
                                    <% end %>
                                    <div class="muted small-text">Active subscriber</div>
                                </div>
                            </div>
                            <span class="pill-soft selected-pill">Selected</span>
                        </label>
                        <% end %>
                        <% end %>
                    </div>
                    <div class="access-disabled-overlay" id="access-disabled-overlay-new" style="<%= @lesson.restricted? ? 'display:none;' : '' %>">
                        <p class="muted">Subscriber selection is available when ‚ÄúPrivate‚Äù is chosen.</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <div class="access-footer card sticky-save lesson-form-actions">
        <div class="muted small-text" id="dirty-indicator-new">Changes are saved when you click Save.</div>
        <div class="card-actions">
            <div class="form-submit-lock__status" style="display:inline-flex; align-items:center; gap:8px; margin-right:12px;">
                <span data-form-submit-lock-target="status" class="muted small-text" style="display:none;"></span>
                <span data-form-submit-lock-target="error" class="small-text" style="display:none; color:#dc2626;"></span>
            </div>
            <%= form.submit(@lesson.persisted? ? "Update lesson" : "Create lesson", class: "btn btn-primary", data: { form_submit_lock_target: "submit" }) %>
            <%= link_to "Cancel", coach_lessons_path, class: "btn btn-ghost", data: { form_submit_lock_target: "cancel", action: "click->form-submit-lock#handleCancelClick" } %>
        </div>
    </div>
    <% end %>
</div>
