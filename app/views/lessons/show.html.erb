<h1><%= @lesson.title %></h1>

<% if current_user&.student? %>
  <% favorited = Favorite.exists?(student_id: current_user.id, lesson_id: @lesson.id) %>
  <% if favorited %>
    <%= button_to "Unfavorite", unfavorite_lesson_path(@lesson), method: :delete, class: "btn secondary" %>
  <% else %>
    <%= button_to "Favorite", favorite_lesson_path(@lesson), method: :post, class: "btn" %>
  <% end %>
<% end %>

<p><%= @lesson.description %></p>

<% if @authorized %>
  <% if @lesson.video_url&.include?("youtube") || @lesson.video_url&.include?("youtu.be") %>
    <div class="video-embed">
      <iframe width="560" height="315" src="<%= @lesson.video_url.sub("watch?v=", "embed/") %>" title="Video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
  <% elsif @lesson.video_url&.include?("vimeo") %>
    <div class="video-embed">
      <iframe src="<%= @lesson.video_url.sub("vimeo.com/", "player.vimeo.com/video/") %>" width="640" height="360" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
    </div>
  <% else %>
    <%= link_to "Watch video", @lesson.video_url, class: "btn", target: "_blank", rel: "noopener" %>
  <% end %>
<% else %>
  <p>Subscribe to unlock this lesson.</p>
  <% if logged_in? && current_user.student? %>
    <%= button_to "Subscribe", coach_subscription_path(@lesson.coach), method: :post, class: "btn" %>
  <% else %>
    <%= link_to "Log in to subscribe", login_path, class: "btn" %>
  <% end %>
<% end %>

<div class="section" style="margin-top: 24px;">
  <h2>Comments</h2>

  <% if @root_comments.any? %>
    <div class="stack">
      <% @root_comments.each do |comment| %>
        <div class="card" id="comment-<%= comment.id %>">
          <p><strong>Student comment</strong> by <%= comment.user.email %></p>
          <p><%= comment.body %></p>

          <% if comment.replies.any? %>
            <div class="stack" style="margin-left: 16px; margin-top: 8px;">
              <% comment.replies.each do |reply| %>
                <div class="card" style="background: #f7f7f9;">
                  <p><strong>Coach reply</strong> by <%= reply.user.email %></p>
                  <p><%= reply.body %></p>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if @can_reply %>
            <%= form_with model: [@lesson, Comment.new], local: true do |f| %>
              <%= f.hidden_field :parent_id, value: comment.id %>
              <div>
                <%= f.label :body, "Reply" %><br>
                <%= f.text_area :body, rows: 2, required: true %>
              </div>
              <div>
                <%= f.submit "Reply", class: "btn secondary" %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="muted">No comments yet.</p>
  <% end %>

  <% if @can_comment %>
    <div class="card" style="margin-top: 12px;">
      <h3>Leave a comment</h3>
      <%= form_with model: [@lesson, Comment.new], local: true do |f| %>
        <div>
          <%= f.label :body, "Your comment" %><br>
          <%= f.text_area :body, rows: 3, required: true %>
        </div>
        <div>
          <%= f.submit "Post comment", class: "btn" %>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="muted">You must be subscribed to comment on this lesson.</p>
  <% end %>
</div>
