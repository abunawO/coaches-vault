<div class="container">
  <% if current_user&.coach? %>
    <%= render "shared/page_header",
          breadcrumbs: [["Dashboard", root_path], ["Lessons", lessons_path]],
          title: content_tag(:span, "ðŸŽ“", class: "page-title-icon") + " My Lessons",
          subtitle: "Manage your library, edit content, and publish updates.",
          primary_action: { label: "New Lesson", url: new_coach_lesson_path(return_to: request.fullpath) },
          meta: [{ label: "Total lessons", value: @lessons.size }] do %>
      <div class="lessons-hero__filter">
        <label class="sr-only" for="lesson-filter">Filter lessons</label>
        <input id="lesson-filter"
               class="input"
               type="text"
               placeholder="Filter lessonsâ€¦"
               autocomplete="off"
               data-lessons-filter />
      </div>
    <% end %>
  <% else %>
    <%= render "shared/page_header",
          title: (@coach ? "Lessons by #{@coach_profile.display_name}" : "Lessons"),
          subtitle: "Browse lessons across coach vaults." %>
  <% end %>

  <div class="grid">
    <% @lessons.each do |lesson| %>
      <div class="mv-card mv-card--lesson"
           data-controller="lesson-card"
           data-lesson-card
           data-filter-text="<%= [lesson.title, lesson.description].compact.join(' ') %>">
        <div class="mv-card__header">
          <h3 class="mv-card__title"><%= lesson.title %></h3>
          <% if lesson.description.present? %>
            <p class="mv-card__subtitle mv-card__desc" data-lesson-card-target="desc"><%= lesson.description %></p>
            <% if lesson.description.length > 140 %>
              <button type="button"
                      class="mv-card__toggle"
                      data-lesson-card-target="toggle"
                      data-action="lesson-card#toggle"
                      aria-expanded="false">
                Show more
              </button>
            <% end %>
          <% end %>
        </div>
        <div class="mv-card__body">
          <% unless current_user&.coach? %>
            <% coach_profile = lesson.coach&.coach_profile %>
            <% coach_name = coach_profile&.display_name || lesson.coach&.email || "Coach" %>
            <span class="muted">by <%= coach_name %></span>
          <% end %>
        </div>
        <div class="mv-card__footer mv-card__actions">
          <% if current_user&.coach? %>
            <%= link_to lesson_path(lesson), class: "icon-btn", aria: { label: "View" }, data: { tooltip: "View" } do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 9s3-6 11-6 11 6 11 6-3 6-11 6S1 9 1 9Z"/><circle cx="12" cy="9" r="2.5"/></svg>
            <% end %>
            <%= link_to edit_coach_lesson_path(lesson), class: "icon-btn", aria: { label: "Edit" }, data: { tooltip: "Edit" } do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4Z"/></svg>
            <% end %>
            <%= link_to access_coach_lesson_path(lesson), class: "icon-btn", aria: { label: "Manage access" }, data: { tooltip: "Manage access" } do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M4 21v-2a4 4 0 0 1 4-4h1"/><path d="M17 12a4 4 0 0 1 4 4v1.5"/></svg>
            <% end %>
            <button type="button"
                    class="icon-btn icon-btn--danger"
                    data-action="confirm-modal#open"
                    data-confirm-title="Delete lesson?"
                    data-confirm-body="This will permanently delete this lesson. This cannot be undone."
                    data-confirm-action="<%= coach_lesson_path(lesson) %>"
                    data-confirm-method="delete"
                    data-confirm-label="Delete"
                    aria-label="Delete"
                    data-tooltip="Delete">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"/></svg>
            </button>
          <% elsif @coach %>
            <%= link_to public_coach_lesson_path(@coach_profile.slug, lesson), class: "icon-btn", aria: { label: "Open" }, data: { tooltip: "Open" } do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 7 10-3-3 10L7 7Z"/><path d="m4 13 4.7-.9"/><path d="m9.2 9.2 4.6 4.6"/><circle cx="4" cy="19" r="2"/></svg>
            <% end %>
          <% else %>
            <%= link_to lesson_path(lesson), class: "icon-btn", aria: { label: "Open" }, data: { tooltip: "Open" } do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 7 10-3-3 10L7 7Z"/><path d="m4 13 4.7-.9"/><path d="m9.2 9.2 4.6 4.6"/><circle cx="4" cy="19" r="2"/></svg>
            <% end %>
          <% end %>
        </div>

        <% if lesson.description.present? %>
          <div class="mv-card__overlay" data-lesson-card-target="overlay">
            <div class="mv-card__overlay-content">
              <button type="button"
                      class="icon-btn icon-btn--ghost mv-card__overlay-close"
                      aria-label="Close"
                      data-action="lesson-card#collapse">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m4 4 8 8"/><path d="m12 4-8 8"/></svg>
              </button>
              <h4 class="mv-card__overlay-title"><%= lesson.title %></h4>
              <div class="mv-card__overlay-body"><%= simple_format(lesson.description) %></div>
              <button type="button"
                      class="btn btn-secondary btn-small"
                      data-action="lesson-card#collapse">
                Show less
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if @lessons.empty? %>
    <%= render "shared/empty_state",
        icon: "ðŸŽ“",
        title: "No lessons yet",
        body: "Create your first lesson to begin building your teaching library.",
        primary_action: { label: "Create your first lesson", url: new_coach_lesson_path(return_to: request.fullpath) } %>
  <% end %>
</div>
